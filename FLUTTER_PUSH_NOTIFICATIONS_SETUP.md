# Push Notifications Setup - Flutter App Handoff

**Date:** February 9, 2026  
**Status:** Backend complete, awaiting Flutter implementation  
**Goal:** Enable push notifications when orders/baskets are updated on the web management app

---

## Summary: What's Already Done ‚úÖ

The backend (Next.js) is **fully configured** for push notifications:

1. ‚úÖ Firebase Admin SDK initialized
2. ‚úÖ Firebase service account key in `.env.local`
3. ‚úÖ Database column added: `customers.fcm_device_token`
4. ‚úÖ API endpoint created: `/api/customer/register-device` (stores device tokens)
5. ‚úÖ Notification sender utility created: `send-notification.ts`
6. ‚úÖ Both status update endpoints now send notifications:
   - `/api/orders/{orderId}/basket/{basketNumber}/service` (service updates)
   - `/api/orders/{orderId}/serviceStatus` (pickup/delivery updates)

---

## What You Need to Do: Flutter App Setup

### Step 1: Install Firebase Dependencies

Add to `pubspec.yaml`:

```yaml
dependencies:
  firebase_core: ^2.24.0
  firebase_messaging: ^14.7.0
  http: ^1.1.0
```

Run:

```bash
flutter pub get
```

---

### Step 2: Configure Firebase in Flutter

#### For Android:

1. **Get Google Services JSON:**
   - Go to Firebase Console ‚Üí Project Settings
   - Download `google-services.json`
   - Place in: `android/app/google-services.json`

2. **Update `android/build.gradle`:**

   ```gradle
   buildscript {
     dependencies {
       classpath 'com.google.gms:google-services:4.3.15'
     }
   }
   ```

3. **Update `android/app/build.gradle`:**
   ```gradle
   plugins {
     id 'com.android.application'
     id 'com.google.gms.google-services'
   }
   ```

#### For iOS (Optional):

1. Update `ios/Podfile` to use platform `:ios, '12.0'` (or higher)
2. Add to `ios/Runner/GeneratedPluginRegistrant.m`
3. Configure APNs certificate in Firebase Console

---

### Step 3: Initialize Firebase on App Startup

**File:** `lib/main.dart`

```dart
import 'package:firebase_core/firebase_core.dart';
import 'firebase_options.dart'; // Generated by flutterfire CLI

void main() async {
  WidgetsFlutterBinding.ensureInitialized();

  await Firebase.initializeApp(
    options: DefaultFirebaseOptions.currentPlatform,
  );

  // Setup notifications
  await setupNotifications();

  runApp(const MyApp());
}

Future<void> setupNotifications() async {
  final messaging = FirebaseMessaging.instance;

  // Request notification permission (iOS only; Android is automatic)
  await messaging.requestPermission(
    alert: true,
    announcement: false,
    badge: true,
    carryForwardToken: true,
    criticalSound: false,
    provisional: false,
    sound: true,
  );

  print('Notifications setup complete');
}
```

Run this to generate Firebase config:

```bash
flutterfire configure
```

---

### Step 4: Register Device Token When Customer Logs In

**Add this to your login/auth flow** (wherever the customer authenticates):

```dart
import 'package:firebase_messaging/firebase_messaging.dart';
import 'package:http/http.dart' as http;
import 'dart:convert';

Future<void> registerDeviceToken(String customerId) async {
  try {
    final messaging = FirebaseMessaging.instance;

    // Get FCM device token
    final token = await messaging.getToken();

    if (token == null) {
      print('‚ùå Failed to get FCM token');
      return;
    }

    print('üì± FCM Token: $token');

    // Send to backend
    final response = await http.post(
      Uri.parse('https://yourapp.com/api/customer/register-device'),
      headers: {'Content-Type': 'application/json'},
      body: jsonEncode({
        'customerId': customerId,
        'deviceToken': token,
      }),
    );

    if (response.statusCode == 200) {
      print('‚úÖ Device token registered successfully');
    } else {
      print('‚ùå Failed to register device token: ${response.body}');
    }
  } catch (e) {
    print('‚ùå Error registering device token: $e');
  }
}
```

**Usage in Login:**

```dart
// After successful login
await registerDeviceToken(customer.id);
```

---

### Step 5: Handle Incoming Notifications (Optional but Recommended)

Add to `main.dart` after `Firebase.initializeApp()`:

```dart
// Handle notifications while app is in foreground
FirebaseMessaging.onMessage.listen((RemoteMessage message) {
  print('üì≤ Notification received while app open:');
  print('Title: ${message.notification?.title}');
  print('Body: ${message.notification?.body}');

  // Show in-app notification (use your toast/snackbar library)
  // Example with flutter_local_notifications:
  showInAppNotification(
    title: message.notification?.title ?? 'Update',
    body: message.notification?.body ?? '',
  );
});

// Handle notification tap
FirebaseMessaging.onMessageOpenedApp.listen((RemoteMessage message) {
  print('üì≤ Notification tapped');
  print('Data: ${message.data}');

  // Navigate to order details or refresh orders
  // navigateToOrder(message.data['orderId']);
});

// Handle background notification (app closed)
FirebaseMessaging.onBackgroundMessage(_firebaseMessagingBackgroundHandler);

Future<void> _firebaseMessagingBackgroundHandler(RemoteMessage message) async {
  print('Handling background message: ${message.messageId}');
  // Run background tasks here if needed
}
```

---

### Step 6: Update API Base URL

**Important:** Replace `https://yourapp.com` in Step 4 with your actual backend URL:

- Development: `http://localhost:3000`
- Production: `https://your-production-domain.com`

---

## Testing

1. **Build and run the app:**

   ```bash
   flutter run
   ```

2. **Log in to the app** with a test customer account

3. **Check backend logs** for:
   - FCM token registered successfully
   - Notification sent messages

4. **Go to web management app** (baskets page)

5. **Click any action button** (Start Service, Complete Pickup, etc.)

6. **Check customer's phone** for push notification üì±

---

## Expected Notification Messages

| Action                    | Notification                           |
| ------------------------- | -------------------------------------- |
| Start Wash on Basket #1   | "Basket #1 Update - Wash started"      |
| Complete Dry on Basket #2 | "Basket #2 Update - Dry completed"     |
| Start Pickup              | "Pickup Update - Pickup started"       |
| Complete Delivery         | "Delivery Update - Delivery completed" |

---

## Files Modified in Backend (For Reference)

- `src/app/utils/firebase-admin.ts` - Firebase initialization
- `src/app/utils/send-notification.ts` - Notification sender utility
- `src/app/api/customer/register-device/route.ts` - Device token registration
- `src/app/api/orders/[orderId]/basket/[basketNumber]/service/route.ts` - Sends notifications on service updates
- `src/app/api/orders/[orderId]/serviceStatus/route.ts` - Sends notifications on pickup/delivery updates

---

## Troubleshooting

| Issue                                | Solution                                             |
| ------------------------------------ | ---------------------------------------------------- |
| Token registration fails             | Check backend URL, ensure API endpoint exists        |
| No notifications received            | Verify `fcm_device_token` column exists in database  |
| Notifications not showing on Android | Ensure `google-services.json` is in correct location |
| Firebase initialization error        | Run `flutterfire configure` again                    |

---

## Next Steps (Optional Enhancements)

- [ ] Add sound to notifications
- [ ] Add action buttons to notifications (Accept/Reject)
- [ ] Save read/unread status for notifications
- [ ] Add in-app notification icon badge
- [ ] Implement notification history screen

---

**Questions?** Check Firebase docs: https://firebase.flutter.dev/docs/messaging/overview
